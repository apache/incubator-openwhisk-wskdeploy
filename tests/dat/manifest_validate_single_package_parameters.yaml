#
# Licensed to the Apache Software Foundation (ASF) under one or more contributor
# license agreements; and to You under the Apache License, Version 2.0.
#

project:
    name: GitHubTriggerSlack
    # inputs for deployment
    inputs:
        PACKAGE_NAME:
            type: string
            description: "Package name"
            required: true
            default: ${PACKAGE_NAME}
    packages:
        ${PACKAGE_NAME}:
            # inputs for deployment
            inputs:
                SLACK_USERNAME:
                    type: string
                    description: "Slack User Name"
                    required: true
                    default: ${SLACK_USERNAME}
                SLACK_URL:
                    type: string
                    description: "Slack Webhook URL"
                    required: true
                    default: https://hooks.slack.com/services/${SLACK_URL}
                SLACK_CHANNEL:
                    type: string
                    description: "Slack Channel"
                    required: true
                    default: "#general"
                SLACK_TOKEN:
                    type: string
                    description: "Slack Token"
                    required: true
                    default: ${SLACK_TOKEN}
                GITHUB_USERNAME:
                    type: string
                    description: "Github User Name"
                    required: true
                    default: ${GITHUB_USERNAME}
                GITHUB_REPOSITORY:
                    type: string
                    description: "Github Repository"
                    required: true
                    default: ${GITHUB_REPOSITORY}
                GITHUB_ACCESS_TOKEN:
                    type: string
                    description: "Github Access Token"
                    required: true
                    default: ${GITHUB_ACCESS_TOKEN}
                RULE_NAME:
                    type: string
                    description: "Rule Name"
                    required: true
                    default: ${RULE_NAME}
                TRIGGER_NAME:
                    type: string
                    description: "Trigger Name"
                    required: true
                    default: ${TRIGGER_NAME}
            dependencies:
                # binding github package named openwhisk-github and slack package openwhisk-slack
                openwhisk-slack:
                    location: /whisk.system/slack
                    inputs:
                        username: ${SLACK_USERNAME}
                        url: ${SLACK_URL}
                        channel: ${SLACK_CHANNEL}
                        token: ${SLACK_TOKEN}
                openwhisk-github:
                    location: /whisk.system/github
                    inputs:
                        username: ${GITHUB_USERNAME}
                        repository: ${GITHUB_REPOSITORY}
                        accessToken: ${GITHUB_ACCESS_TOKEN}
            triggers:
                # Creating trigger to fire events when a user pushes to a github repository
               $TRIGGER_NAME:
                    feed: openwhisk-github/webhook
                    inputs:
                        events: 'push'
            actions:
                # Creating action that is printing data which is written to the database
                message-ify-github-response:
                    function: actions/repackage-message.js
            sequences:
                # Creating sequence to connect the github-repackage-info action with the slack post action
                github_slack_integration_sequence:
                    actions: message-ify-github-response, openwhisk-slack/post
            rules:
                # Creating rule that maps github push trigger to sequence
                $RULE_NAME:
                    trigger: $TRIGGER_NAME
                    action: github_slack_integration_sequence
